<!DOCTYPE html>

<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/asvd/dragscroll/master/dragscroll.js"></script>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <link rel="icon" href="/static/favicon.png">

        <meta property="og:type" content="website" />
        <meta property="og:image" content="/static/preview.tree.png">
        <meta property="og:title" content="Мое родословие">
        <meta property="og:description" content="Родословное древо Жагориных, Черепановых, Мотыревых, Фаренюков...">

		<style>
			#person-snippet-container {
				margin-bottom: 18px;
			}
            #person-snippet-container .panel {
                margin-bottom: 0px;
            }
			#person-snippet-container .panel-body {
				padding: 10px 15px 0px 15px;
				max-height: 180px;
				min-height: 180px;
				overflow-y: auto;
			}

			#person-snippet-container .panel-heading {
				padding: 5px 15px 5px 15px;
			}
            
            #person-snippet-container .img-person {
                max-width: 160px;
                max-height: 160px;
            }  
            
			.hilighted-person {
			    position: absolute;
			    box-shadow: 0px 0px 50px #0000ff;
                border-radius: 10px;
			}

            .map-search-tag {
                position:absolute;
                z-index: -1;
            }
            body {
                padding: 0px;
            }

            #tree-container {
                position: absolute;
                overflow: auto;
                width: 100%;
                height: 100vh;
                cursor: -webkit-grab;
                padding-bottom: 220px;
            }
		</style>
        
        <style>
          .carousel.full-screen {
            #background-image: url(/static/photo_background.jpg);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
          }
          
          .carousel.full-screen > .carousel-inner > .item > img,
          .carousel.full-screen > .carousel-inner > .item > a > img {
              margin: 0 auto;
              max-height: 100%;
              max-width: 100%;
              position:relative;
              top:50%;
              transform: translateY(-50%);
          }
          
        </style>
  
		<script>
            // загружает фотографии имеющие аттрибут lazy-src
            function loadLazyContent(container) {
                container.find('img[lazy-src]').each(function(){
                    var img = $(this);
                    img.attr("src", img.attr("lazy-src"));
                    img.removeAttr("lazy-src");
                });
            }

		    // отображает информацию о персоне в блоке внизу страницы
			function viewPersonSnippet(person_uid) {
			    var snippet = $('#snippets').find('#snippet-for-'+person_uid).first();
                loadLazyContent(snippet);
                snippet = snippet.clone(withDataAndEvents=true);
				var container = $('#person-snippet-container');
                container.empty();
                container.append(snippet);
			}

            // фокусируется на выбранной персоне в дереве и подсвечивает ее
			function hilightPersonArea(person_uid) {
			    var person_area = $('#tree-map .select-person-'+person_uid);
                if (!person_area.length) {
                    return; // некоторые персоны могут не присутствовать в дереве
                }
			    coords = person_area.attr('coords').split(',').map(function(item) {
					return parseInt(item, 10);
				});

				var left = coords[0];
				var top = coords[1];
				var width = coords[2] - left;
				var height = coords[3] - top;

                scrollTreeIfNeed(left, top, width, height);

				h = $('.hilighted-person');
				h.css({'left': left+'px', 'top': top+'px', 'width': width+'px', 'height': height+'px'});
			}

            // скроллит дерево (если нужно) для того чтобы выбранный участок оказался на экране
            function scrollTreeIfNeed(left, top, width, height) {
                tree = $('#tree-container')
                var scrollTop = tree.scrollTop();
                var scrollLeft = tree.scrollLeft();

                var wWidth = tree.width();
                var wHeight = tree.height();
                var navHeight = $('#person-snippet-container').height();


                // если area целиком влазит в экран (и не скрыта нижней панелью) - скролллинг не нужен (ее и так видно)
                var padding = 10
                if (scrollLeft+padding < left && left+width+padding < scrollLeft+wWidth &&
                    scrollTop+padding < top && top+height+padding < scrollTop+wHeight-navHeight) {
                    return;
                }
                // позиция, которая будет в левом верхнем углу браузера
                tree.scrollLeft(left+width/2-wWidth/2);
                tree.scrollTop(top+height/2-(wHeight-navHeight)/2);
            }

		</script>
		{% import 'person_snippet.html' as ps %}
        {% import 'photo_carousel.html' as pc %}
        {% import 'yandex_metrika.html' as metrika %}
        
        {{ metrika.tree_counter() }}
    </head>
	<body>
            {% set tree = context.tree %}
            {% set persons_snippets = context.data.persons_snippets %}
            
            <div id="tree-container" class="dragscroll">
                <img id="tree-img" src="{{tree.img}}" usemap="#tree_nodes_map"></img>
                <div class='hilighted-person'></div>
                <!-- поисковые теги - невидимые надписи под картой - используются для ctrl+F -->
                {% for person_uid, node in tree.map.nodes.items() %}
                    {% if person_uid in persons_snippets %}
                        {% set person = persons_snippets[person_uid] %}
                        <div class="map-search-tag" style="top: {{node.y1}}px; left: {{node.x1}}px;">{{person.name}}</div>
                    {% endif %}
                {% endfor %}


                <map id="tree-map" name='tree_nodes_map'>
                    {% for person_uid, node in tree.map.nodes.items() %}
                    <area class="select-person-{{person_uid}}" coords="{{node.rect}}" shape="rect" href="#">
                    {% endfor %}
                </map>

            </div>
			<nav id="person-snippet-container" class="navbar navbar-default navbar-fixed-bottom">
			</nav>

			<div id="snippets" style="display:none;">
				{% for person_uid, person_snippet in persons_snippets.items() %}
					<div id="snippet-for-{{person_uid}}">
						{{ ps.draw_person_snippet(person_snippet, context.person_context(person_uid)) }}
					</div>

					<script>
						$(document).ready(function(){
						    items = $(".select-person-{{person_uid}}");
							$(".select-person-{{person_uid}}").click(function(e) {
								e.preventDefault();
								viewPersonSnippet('{{person_uid}}');
								hilightPersonArea('{{person_uid}}');
                                window.location.hash = "{{person_uid}}";
							});
						});
					</script>
				{% endfor %}
			</div>
            
            <div id="carousels">
                {% for person_uid, person_snippet in persons_snippets.items() %}
                    {% if person_snippet.photos %}
                        {{ pc.draw_photo_carousel('carousel-for-'+person_uid, person_snippet.photos) }}
                    {% endif %}    
                {% endfor %}
            </div>


            <script>
                $(document).ready(function() {
                    // карусель в режиме полного экрана
                    var $item = $('.carousel.full-screen .item'); 
                    var $wHeight = $(window).height();
                    $item.height($wHeight);
                    $(window).on('resize', function (){
                      $wHeight = $(window).height();
                      $item.height($wHeight);
                    });
                    
                    // загрузка ленивого контента в модальных окнах
                    $('.modal').on('shown.bs.modal', function() {
                        loadLazyContent($(this));
                    })
            
                    // запуск карусельки
                    //$('.carousel').carousel({
                    //  interval: 5000,
                    //  pause: "true"
                    //});
                });    
            </script>    
  
            <script>
                $(document).ready(function(){
                    selected_uid = window.location.hash.substring(1);
                    if (selected_uid) {
                        $(".select-person-"+selected_uid).first().click();
                    }
                });
            </script>

	</body>
</html>