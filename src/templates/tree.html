<!DOCTYPE html>

<html>
	<head>
        <title>{{context.tree.name}}</title>
        
		<script src="/static/js/jquery.min.js"></script>
		<script type="text/javascript" src="/static/js/dragscroll.js"></script>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="/static/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Родословное древо Жагориных, Черепановых, Мотыревых, Фаренюков..."/>
        
        <meta property="og:type" content="website" />
        <meta property="og:image" content="{{url_for('static', filename='preview.tree.png', _external=True)}}"/>
        <meta property="og:image" content="{{url_for('tree', tree_name=context.tree.uid, _external=True)}}"/>
        <meta property="og:title" content="Мое родословие"/>
        <meta property="og:description" content="Родословное древо Жагориных, Черепановых, Мотыревых, Фаренюков..."/>
        
        <meta name="yandex-verification" content="d3a78397fee01474" />
        
        <link rel="icon" href="/static/favicon.png">
        <link rel="stylesheet" type="text/css" href="/static/css/carousel-full-screen.css">
        <link rel="stylesheet" type="text/css" href="/static/css/fa-colored.css">
        <script type="text/javascript" src="/static/js/carousel-full-screen.js"></script>
        <script type="text/javascript" src="/static/js/lazy-content.js"></script>

		<style>
			#person-snippet-container {
				margin-bottom: 18px;
			}
            #person-snippet-container .panel {
                margin-bottom: 0px;
            }
			#person-snippet-container .panel-body {
				padding: 10px 15px 0px 15px;
				max-height: 180px;
				min-height: 180px;
				overflow-y: auto;
			}

			#person-snippet-container .panel-heading {
				padding: 5px 15px 5px 15px;
			}
            
            #person-snippet-container .img-person {
                max-width: 160px;
                max-height: 160px;
            }  
            
			.hilighted-person {
			    position: absolute;
			    box-shadow: 0px 0px 50px #0000ff;
                border-radius: 10px;
			}

            .map-search-tag {
                position:absolute;
                z-index: -1;
            }
            body {
                padding: 0px;
            }

            #tree-container {
                position: absolute;
                overflow: auto;
                width: 100%;
                height: 100vh;
                cursor: -webkit-grab;
                padding-bottom: 220px;
            }
		</style>
  
		<script>
		    // отображает информацию о персоне в блоке внизу страницы
			function viewPersonSnippet(person_uid) {
			    var snippet = $('#snippets').find('#snippet-for-'+person_uid).first();
                loadLazyContent(snippet);
                snippet = snippet.clone(withDataAndEvents=true);
				var container = $('#person-snippet-container');
                container.empty();
                container.append(snippet);
			}

            // фокусируется на выбранной персоне в дереве и подсвечивает ее
			function hilightPersonArea(person_uid) {
			    var person_area = $('#tree-map area.select-person[person-uid='+person_uid+']');
                if (!person_area.length) {
                    return; // некоторые персоны могут не присутствовать в дереве
                }
			    coords = person_area.attr('coords').split(',').map(function(item) {
					return parseInt(item, 10);
				});

				var left = coords[0];
				var top = coords[1];
				var width = coords[2] - left;
				var height = coords[3] - top;

                scrollTreeIfNeed(left, top, width, height);

				h = $('.hilighted-person');
				h.css({'left': left+'px', 'top': top+'px', 'width': width+'px', 'height': height+'px'});
			}

            // скроллит дерево (если нужно) для того чтобы выбранный участок оказался на экране
            function scrollTreeIfNeed(left, top, width, height) {
                tree = $('#tree-container')
                var scrollTop = tree.scrollTop();
                var scrollLeft = tree.scrollLeft();

                var wWidth = tree.width();
                var wHeight = tree.height();
                var navHeight = $('#person-snippet-container').height();


                // если area целиком влазит в экран (и не скрыта нижней панелью) - скролллинг не нужен (ее и так видно)
                var padding = 10
                if (scrollLeft+padding < left && left+width+padding < scrollLeft+wWidth &&
                    scrollTop+padding < top && top+height+padding < scrollTop+wHeight-navHeight) {
                    return;
                }
                // позиция, которая будет в левом верхнем углу браузера
                tree.scrollLeft(left+width/2-wWidth/2);
                tree.scrollTop(top+height/2-(wHeight-navHeight)/2);
            }
            
            function selectPerson(link) {
                var person_uid = link.attr('person-uid');
                viewPersonSnippet(person_uid);
				hilightPersonArea(person_uid);
                window.location.hash = person_uid;
            }

		</script>
		{% import 'person_snippet.html' as ps %}
        {% import 'photo_carousel.html' as pc %}
        {% import 'yandex_metrika.html' as metrika %}
        
        {{ metrika.common_counter(user) }}
        {{ metrika.goals() }}
    </head>
	<body>
            {% set tree = context.tree %}
            {% set persons_snippets = context.data.persons_snippets %}
            
            <div id="tree-container" class="dragscroll">
                <img id="tree-img" src="{{url_for('static', filename='1x1_white.png')}}" lazy-src="{{tree.img}}" width="{{tree.map.width}}" height="{{tree.map.height}}" usemap="#tree_nodes_map"></img>
                <div class='hilighted-person'></div>
                <!-- поисковые теги - невидимые надписи под картой - используются для ctrl+F -->
                {% for person_uid, node in tree.map.nodes.items() %}
                    {% if person_uid in persons_snippets %}
                        {% set person = persons_snippets[person_uid] %}
                        <div class="map-search-tag" style="top: {{node.y1}}px; left: {{node.x1}}px;">{{person.name}}</div>
                    {% endif %}
                {% endfor %}


                <map id="tree-map" name='tree_nodes_map'>
                    {% for person_uid, node in tree.map.nodes.items() %}
                    <area class="select-person" person-uid="{{person_uid}}" coords="{{node.rect}}" shape="rect" href="#">
                    {% endfor %}
                </map>

                
            </div>
			<nav id="person-snippet-container" class="navbar navbar-default navbar-fixed-bottom">
			</nav>
            
    <nav class="navbar">
        <div class="navbar-header">
          <!-- Кнопка «Гамбургер» отображается только в мобильном виде (предназначена для открытия основного содержимого Navbar) -->
          <a href="#" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-main">
            <span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span>
          </a>
        </div>
        <div class="collapse navbar-collapse" id="navbar-main">
            <ul class="nav navbar-nav navbar-right pull-right">
              <li><a href="#" data-toggle="modal" data-target="#contacts"><span class="glyphicon glyphicon-envelope"></span> Написать автору</a></li>
              <li><a href="/lk" target='_blank'><span class="glyphicon glyphicon-user"></span> 
              {% if user and user.is_authenticated() %} {{user.auth_info().me.first_name}} {% else %} Войти {% endif %}</a></li>
            </ul>
        </div>
    </nav>

    <!--Author contacts-->
    <div id="contacts" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Автор: <a href="/person/hmBLFFLwiQ">Жагорина Ксения Андреевна</a></h4>
          </div>
          <div class="modal-body">
            <p><ul class="list-unstyled">
                <li><i class="fa fa-fw fa-odnoklassniki fa-colored"></i><a href="https://ok.ru/ksenia.zhagorina"> https://ok.ru/ksenia.zhagorina</a></li>
                <li><i class="fa fa-fw fa-vk fa-colored"></i><a href="https://vk.com/kzhagorina"> https://vk.com/kzhagorina</a></li>
                <li><i class="fa fa-fw fa-telegram fa-colored"></i> <a title="Telegram" href="tg://resolve?domain=KseniaZhagorina">KseniaZhagorina</a></li>
            </ul></p>
          </div>
        </div>

      </div>
    </div>

<!--noindex-->            
			<div id="snippets" style="display:none;">
				{% for person_uid, person_snippet in persons_snippets.items() %}
					<div id="snippet-for-{{person_uid}}">
						{{ ps.draw_person_snippet(person_snippet, context.person_context(person_uid)) }}
					</div>
				{% endfor %}
			</div>
            
            <script>
                $(document).ready(function(){
                    $(".select-person").click(function(e) {
                        e.preventDefault();
                        selectPerson($(this));
                    });
                });
            </script>
            
            <div id="carousels">
                {% for person_uid, person_snippet in persons_snippets.items() %}
                    {% if person_snippet.photos %}
                        {{ pc.draw_photo_carousel('carousel-for-'+person_uid, person_snippet.photos) }}
                    {% endif %}    
                {% endfor %}
            </div>

            <script>
                initCarouselFullScreen();
            </script>    
  
            <script>
                // Загружаем реальную картинку дерева вместо заглушки
                $(window).load(function(){
                    var tree_container = $('#tree-container').first();
                    loadLazyContent(tree_container);
                });
                
                // Эмулируем клик на персону, если в якоре урла передан person_uid
                // Это проскроллит экран до персоны, выделит ее и откроет сниппет с информацией
                $(document).ready(function(){
                    selected_uid = window.location.hash.substring(1);
                    if (selected_uid) {
                        $(".select-person[person-uid='"+selected_uid+"']").first().click();
                    }
                });
            </script>
<!--/noindex-->
	</body>
</html>